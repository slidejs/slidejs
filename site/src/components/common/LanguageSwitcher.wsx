/** @jsxImportSource @wsxjs/wsx-core */
/**
 * LanguageSwitcher Component
 * è¯­è¨€åˆ‡æ¢å™¨ç»„ä»¶ï¼Œç”¨äºåˆ‡æ¢ i18next çš„è¯­è¨€
 * ä¸ä½¿ç”¨å›½æ——å›¾æ ‡ï¼Œä½¿ç”¨è¯­è¨€åç§°æ˜¾ç¤º
 *
 * è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ç»„ä»¶ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ WSXJS ä¸­ä½¿ç”¨ i18next
 * å‚è€ƒ RFC-0029: i18next å›½é™…åŒ–æ”¯æŒ
 */
import { WebComponent, autoRegister, state } from '@wsxjs/wsx-core';
import { i18nInstance } from '@wsxjs/wsx-i18next';
import styles from './LanguageSwitcher.css?inline';

/**
 * è¯­è¨€é€‰é¡¹æ¥å£
 */
export interface LanguageOption {
  /** è¯­è¨€ä»£ç ï¼ˆå¦‚ 'en', 'zh'ï¼‰ */
  code: string;
  /** è¯­è¨€æ˜¾ç¤ºåç§°ï¼ˆå¦‚ 'English', 'ä¸­æ–‡'ï¼‰ */
  name: string;
}

@autoRegister({ tagName: 'language-switcher' })
export default class LanguageSwitcher extends WebComponent {
  /** æ”¯æŒçš„è¯­è¨€åˆ—è¡¨ */
  private languages: LanguageOption[] = [
    { code: 'en', name: 'English' },
    { code: 'zh', name: 'ä¸­æ–‡' },
  ];

  /** å½“å‰é€‰ä¸­çš„è¯­è¨€ä»£ç  */
  @state private currentLanguage: string = 'en';

  /** ä¸‹æ‹‰èœå•æ˜¯å¦æ‰“å¼€ */
  @state private isOpen: boolean = false;

  /** ä¸‹æ‹‰èœå•å…ƒç´ å¼•ç”¨ */
  private dropdownElement?: HTMLElement;
  private buttonElement?: HTMLElement;

  constructor() {
    super({
      styles,
      styleName: 'language-switcher',
    });
  }

  render(): HTMLElement {
    const currentLang = this.languages.find(lang => lang.code === this.currentLanguage);
    const displayName = currentLang?.name || this.currentLanguage.toUpperCase();

    return (
      <div class="language-switcher-container">
        <button
          ref={el => (this.buttonElement = el)}
          class="language-switcher-btn"
          onClick={this.toggleDropdown}
          aria-label={`Current language: ${displayName}`}
          aria-expanded={this.isOpen}
          aria-haspopup="listbox"
        >
          <span class="language-switcher-icon">ğŸŒ</span>
          <span class="language-switcher-text">{displayName}</span>
          <span class="language-switcher-arrow">{this.isOpen ? 'â–²' : 'â–¼'}</span>
        </button>

        {this.isOpen && (
          <div
            ref={el => (this.dropdownElement = el)}
            class="language-switcher-dropdown"
            role="listbox"
          >
            {this.languages.map(lang => (
              <button
                key={lang.code}
                class={`language-switcher-option ${
                  lang.code === this.currentLanguage ? 'active' : ''
                }`}
                onClick={() => this.selectLanguage(lang.code)}
                role="option"
                aria-selected={lang.code === this.currentLanguage}
              >
                <span class="language-name">{lang.name}</span>
                <span class="language-code">{lang.code.toUpperCase()}</span>
              </button>
            ))}
          </div>
        )}
      </div>
    );
  }

  /**
   * åˆ‡æ¢ä¸‹æ‹‰èœå•
   */
  private toggleDropdown = (): void => {
    this.isOpen = !this.isOpen;
    this.rerender();

    if (this.isOpen) {
      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
      setTimeout(() => {
        document.addEventListener('click', this.handleOutsideClick, true);
      }, 0);
    } else {
      document.removeEventListener('click', this.handleOutsideClick, true);
    }
  };

  /**
   * å¤„ç†ç‚¹å‡»å¤–éƒ¨åŒºåŸŸ
   */
  private handleOutsideClick = (event: Event): void => {
    const target = event.target as Node;
    if (
      this.dropdownElement &&
      this.buttonElement &&
      !this.dropdownElement.contains(target) &&
      !this.buttonElement.contains(target)
    ) {
      this.isOpen = false;
      document.removeEventListener('click', this.handleOutsideClick, true);
    }
  };

  /**
   * é€‰æ‹©è¯­è¨€
   */
  private selectLanguage = (languageCode: string): void => {
    if (languageCode === this.currentLanguage) {
      this.isOpen = false;
      this.rerender();
      return;
    }

    // æ›´æ”¹ i18next è¯­è¨€
    i18nInstance.changeLanguage(languageCode).then(() => {
      this.currentLanguage = languageCode;
      this.isOpen = false;
      this.rerender();

      // ä¿å­˜åˆ° localStorage
      localStorage.setItem('wsx-language', languageCode);
    });
  };

  /**
   * ç»„ä»¶è¿æ¥æ—¶åˆå§‹åŒ–
   */
  protected onConnected(): void {
    // ä» localStorage æˆ– i18next è·å–å½“å‰è¯­è¨€
    const savedLanguage = localStorage.getItem('wsx-language');
    const fallbackLng = i18nInstance.options.fallbackLng;
    const fallbackLngStr =
      typeof fallbackLng === 'string'
        ? fallbackLng
        : Array.isArray(fallbackLng)
          ? fallbackLng[0]
          : 'en';
    const i18nLanguage = i18nInstance.language || fallbackLngStr;

    // è·å–åŸºç¡€è¯­è¨€ä»£ç ï¼ˆå¤„ç† 'en-US' -> 'en' çš„æƒ…å†µï¼‰
    const baseLanguage = (savedLanguage || i18nLanguage).split('-')[0];

    if (baseLanguage !== this.currentLanguage) {
      this.currentLanguage = baseLanguage;
      // å¦‚æœ localStorage ä¸­çš„è¯­è¨€ä¸ i18next ä¸ä¸€è‡´ï¼Œæ›´æ–° i18next
      if (savedLanguage && savedLanguage !== i18nLanguage) {
        i18nInstance.changeLanguage(savedLanguage);
      }
    }

    // ç›‘å¬ i18next è¯­è¨€å˜åŒ–äº‹ä»¶
    i18nInstance.on('languageChanged', this.handleLanguageChanged);
  }

  /**
   * ç»„ä»¶æ–­å¼€è¿æ¥æ—¶æ¸…ç†
   */
  protected onDisconnected(): void {
    i18nInstance.off('languageChanged', this.handleLanguageChanged);
    document.removeEventListener('click', this.handleOutsideClick, true);
  }

  /**
   * å¤„ç† i18next è¯­è¨€å˜åŒ–äº‹ä»¶
   */
  private handleLanguageChanged = (lng: string): void => {
    const baseLanguage = lng.split('-')[0];
    if (baseLanguage !== this.currentLanguage) {
      this.currentLanguage = baseLanguage;
      this.rerender();
    }
  };
}
